# 低代码引擎 v1.1.0 需求文档

## 1. 项目概述

### 1.1 版本信息

- **版本号**: v1.1.0
- **发布日期**: 2026年第一季度
- **基于版本**: v1.0.0 MVP

### 1.2 项目背景

低代码引擎 v1.0.0 已成功实现基础的可视化编辑功能，但在数据管理、编辑体验和组件丰富度方面仍有提升空间。v1.1.0 版本将重点解决这些核心问题，提升平台的易用性和功能完整性。

### 1.3 核心目标

1. **实现数据建模自动化** - 通过可视化数据对象设计器，降低数据管理门槛
2. **提升编辑体验** - 提供操作记录和历史展示功能
3. **完善组件体系** - 丰富输入和展示组件，优化Form和Table功能

## 2. 功能需求

### 2.1 数据对象管理系统（最高优先级）

#### 2.1.1 功能描述

创建可视化的数据对象设计系统，与前端设计面板无缝配合，实现数据表的创建、管理和自动同步。

#### 2.1.2 核心功能

**2.1.2.1 数据对象设计器**

- 创建/编辑数据表结构
- 定义字段属性
- 实时预览数据结构
- 自动生成数据库表

**字段类型支持**：

- 文本（string）
- 数字（number）
- 布尔值（boolean）
- 日期（date）
- 选择器（select）：下拉选择
- 文件上传（file）
- JSON对象（json）

**字段属性**：

- 字段名称
- 字段类型
- 是否必填（required）
- 唯一性约束（unique）
- 默认值（defaultValue）
- 选择器选项（options）
- 验证规则（validation）

**2.1.2.2 验证规则系统**

基础验证：

- 必填验证
- 最大/最小长度
- 最大/最小值
- 正则表达式验证

预设验证模板：

- 邮箱格式
- 手机号格式
- 身份证号格式
- URL格式

**2.1.2.3 数据对象与组件联动**

- Table组件可直接绑定数据对象
- Form组件根据数据对象自动生成字段配置
- 字段类型到组件类型的自动映射
- 数据验证规则自动应用到组件

**2.1.2.4 数据管理界面**
功能列表：

- 查看所有数据对象列表
- 创建新数据对象
- 编辑数据对象结构（向后兼容的修改）
- 查看数据预览（前100条记录）
- 删除数据对象
- 导入/导出数据结构定义

#### 2.1.3 技术要求

**数据同步策略**：

- 检测数据结构变化
- 自动为已有记录添加新字段（默认值为空或null）
- 生成并执行必要的数据库迁移脚本
- 确保数据完整性和一致性

**数据模型示例**：

```typescript
interface DataObject {
  id: string
  name: string
  description?: string
  fields: FieldDefinition[]
  createdAt: Date
  updatedAt: Date
}

interface FieldDefinition {
  name: string
  type: 'string' | 'number' | 'boolean' | 'date' | 'select' | 'file' | 'json'
  required: boolean
  unique: boolean
  defaultValue?: any
  options?: string[] // 用于select类型
  validation?: ValidationRule[]
}
```

### 2.2 编辑体验提升

#### 2.2.1 功能描述

记录用户的每一个编辑操作，提供清晰的操作历史展示，提升编辑器的专业性和可追溯性。

#### 2.2.2 核心功能

**2.2.2.1 操作记录系统**

- 记录所有编辑操作（添加、删除、更新、移动组件）
- 记录操作时间戳
- 记录操作前后的状态
- 生成操作描述文本

**操作类型**：

- 添加组件：如"添加了 Button 组件"
- 删除组件：如"删除了 Text 组件"
- 修改属性：如"修改了 Button 的文本为'提交'"
- 移动组件：如"移动了 Container 的位置"

**数据结构**：

```typescript
interface Operation {
  id: string
  type: 'add' | 'delete' | 'update' | 'move'
  target: string // 组件ID
  description: string
  timestamp: Date
  before?: any // 操作前的状态
  after?: any // 操作后的状态
}
```

**2.2.2.2 操作历史展示**

- 展示方式：浮动窗口，通过按钮触发弹出
- 显示内容：操作描述 + 时间
- 排序方式：按时间倒序显示
- 数量限制：最多显示最近50条记录
- 功能：只读展示，支持滚动查看

**界面设计要求**：

```
操作历史
┌─────────────────────────┐
│ • 10:30 修改了 Button 文本│
│ • 10:29 添加了 Container │
│ • 10:28 删除了 Text 组件 │
│ • 10:25 移动了图片位置   │
│ • 10:24 添加了 Image 组件 │
│ ...                     │
└─────────────────────────┘
```

#### 2.2.3 技术要求

- 操作记录需实时更新，不影响编辑器性能
- 历史记录数据需持久化保存
- 支持页面刷新后历史记录的恢复

### 2.3 组件库扩展

#### 2.3.1 功能描述

扩展组件库，增加输入类和展示类组件，优化Form和Table组件的功能，满足更广泛的业务场景需求。

#### 2.3.2 新增组件

**2.3.2.1 输入类组件（第一批）**

1. **Input 组件**
   - 支持类型：text、password、number、email、search
   - 属性配置：
     - placeholder（占位符）
     - required（是否必填）
     - maxLength（最大长度）
     - pattern（正则表达式）
     - disabled（禁用状态）
     - readonly（只读状态）
   - 状态支持：normal、error、disabled、readonly

2. **Select 组件**
   - 支持模式：单选、多选
   - 功能特性：
     - 搜索过滤
     - 选项来源：静态配置、动态数据绑定
     - 清空选项
     - 禁用选项

3. **Checkbox/Radio 组件**
   - 布局方式：横向排列、纵向排列
   - 功能特性：
     - 默认值设置
     - 禁用状态
     - 分组显示
     - 全选/取消全选（仅Checkbox）

4. **Textarea 组件**
   - 功能特性：
     - 可调整大小
     - 字数统计显示
     - 最大长度限制
     - 自动高度扩展
     - 禁用/只读状态

5. **DatePicker 组件**
   - 功能特性：
     - 日期选择
     - 日期范围选择
     - 快捷选项（今天、本周、本月等）
     - 自定义日期格式
     - 禁用日期设置

6. **Switch 组件**
   - 功能特性：
     - 开关状态切换
     - 自定义开启/关闭文本
     - 尺寸变化（大、中、小）
     - 禁用状态

**2.3.2.2 展示类组件（第二批）**

1. **Image 组件**
   - 图片来源：URL、本地上传
   - 适配模式：fill、contain、cover、none
   - 交互功能：
     - 点击放大
     - 点击跳转
     - 自定义点击事件
   - 状态处理：
     - 加载中状态
     - 加载失败占位图

2. **Card 组件**
   - 结构组成：
     - 标题区域
     - 内容区域
     - 操作区域
   - 样式配置：
     - 阴影等级（0-4级）
     - 圆角大小
     - 悬停效果
     - 内边距设置

#### 2.3.3 组件优化

**2.3.3.1 Form 组件优化**

设计理念：Form作为数据容器，内部可自由拖拽和排列各种输入组件。

**核心特性**：

- 拖拽支持：可将输入组件拖入Form容器
- 自动布局：支持拖拽后的自动排列和对齐
- 数据收集：自动收集内部所有输入组件的值
- 混合模式：支持可选的数据映射规则

**数据收集机制**：

```typescript
// 自动收集示例
const formData = {
  name: input1.value, // 通过组件name或id映射
  email: input2.value,
  age: numberInput.value,
}

// 带映射的收集
const mappedData = {
  userName: input1.value, // 重命名字段
  contactEmail: input2.value,
  userAge: numberInput.value,
}
```

**2.3.3.2 Table 组件优化**

数据源：仅支持绑定数据对象创建的表。

**功能增强**：

1. **列配置**
   - 列标题设置
   - 列宽配置（固定、百分比、自适应）
   - 列排序（升序/降序）
   - 列显示/隐藏
   - 列固定（左侧/右侧）

2. **数据处理**
   - 服务端排序
   - 服务端过滤
   - 分页配置
   - 数据缓存

3. **交互优化**
   - 行悬停效果
   - 行选中（单选/多选）
   - 空状态展示
   - 加载状态
   - 错误处理

#### 2.3.4 属性面板规范

所有组件的属性面板采用统一的分类标签页方式：

1. **属性标签页**
   - 组件基础属性
   - 组件特有属性
   - 数据绑定配置

2. **样式标签页**
   - 布局设置（间距、对齐等）
   - 视觉样式（颜色、字体等）
   - 响应式配置

3. **事件标签页**
   - 事件类型列表
   - 事件处理配置
   - 动作绑定

4. **数据标签页**
   - 数据源配置
   - 数据映射规则
   - 验证规则

## 3. 非功能需求

### 3.1 性能要求

- 操作记录不影响编辑器流畅度
- 组件拖拽响应时间 < 100ms
- 数据对象保存响应时间 < 2s

### 3.2 兼容性要求

- 保持与 v1.0.0 的完全兼容
- 旧版本页面可正常升级和使用

### 3.3 可用性要求

- 新用户 30 分钟内完成第一个数据对象创建
- 操作历史直观易懂
- 组件属性配置清晰明确

## 4. 技术方案

### 4.1 技术架构

```
数据对象管理系统
├── 前端
│   ├── 数据对象设计器组件
│   ├── 数据管理界面
│   ├── 数据对象状态管理（Zustand）
│   └── 数据同步服务
├── 后端
│   ├── 数据对象 CRUD API
│   ├── 数据库迁移服务
│   └── 数据验证服务
└── 数据库
    ├── data_objects 表（存储数据对象定义）
    └── 业务表（根据数据对象动态创建）
```

### 4.2 关键技术点

1. **动态表创建**
   - 使用 Supabase 的 Dynamic SQL 功能
   - 实现数据对象定义到数据库表的映射

2. **数据同步**
   - 版本控制机制
   - 增量更新策略
   - 数据迁移脚本生成

3. **组件数据收集**
   - 基于 React Context 的数据收集机制
   - 支持嵌套组件的数据收集

### 4.3 数据库设计

**data_objects 表**：

```sql
CREATE TABLE data_objects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  fields JSONB NOT NULL DEFAULT '[]'::jsonb,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

## 5. 实施计划

### 5.1 开发阶段

**第1-2周：数据对象管理系统（最高优先级）**

- 数据对象设计器开发
- 数据管理界面开发
- 数据同步机制实现

**第3周：操作记录与历史展示**

- 操作记录系统实现
- 操作历史展示界面开发

**第4-5周：输入类组件开发**

- 6个输入组件的开发
- 组件属性面板配置

**第6周：展示类组件开发**

- Image 组件开发
- Card 组件开发

**第7周：组件优化**

- Form 容器化改造
- Table 组件优化

**第8周：集成测试与优化**

- 功能集成测试
- 性能优化
- 用户体验优化

### 5.2 风险与应对

1. **风险**：动态数据表创建可能遇到数据库限制
   - **应对**：充分测试 Supabase 的动态 SQL 能力，准备备选方案

2. **风险**：数据同步可能出现数据不一致
   - **应对**：实现事务机制，确保数据一致性

3. **风险**：Form 容器化可能影响现有页面
   - **应对**：提供迁移工具，确保向后兼容

## 6. 验收标准

### 6.1 功能验收

1. **数据对象管理系统**
   - [ ] 可视化创建数据对象
   - [ ] 支持 7 种字段类型
   - [ ] 自动生成数据库表
   - [ ] 数据结构变更自动同步

2. **操作历史**
   - [ ] 记录所有编辑操作
   - [ ] 浮动窗口展示历史
   - [ ] 最多显示 50 条记录

3. **新组件**
   - [ ] 6 个输入组件功能完整
   - [ ] Image 和 Card 组件正常工作
   - [ ] Form 容器化改造完成
   - [ ] Table 支持数据对象绑定

### 6.2 性能验收

- [ ] 编辑器操作流畅度不降低
- [ ] 数据对象保存时间 < 2s
- [ ] 页面加载时间 < 3s

### 6.3 用户体验验收

- [ ] 新用户可在 30 分钟内完成第一个数据对象创建
- [ ] 操作历史清晰可读
- [ ] 组件属性配置直观

## 7. 附录

### 7.1 术语表

- **数据对象**：指用户通过设计器创建的数据表结构定义
- **组件容器**：可以包含其他组件的特殊组件，如 Form
- **操作记录**：记录用户在编辑器中的所有操作

### 7.2 相关文档

- [v1.0.0 MVP 需求文档](./prd.md)
- [技术设计文档](../../development/architecture.md)
- [组件 DSL 设计](../../development/core/dsl-schema.md)

---

**文档版本**：1.0
**最后更新**：2025-12-11
**审批状态**：待审批
